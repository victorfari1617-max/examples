import Stripe from "stripe";

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY);

export default async function handler(req, res) {
  if (req.method !== "POST")
    return res.status(405).json({ error: "Método não permitido" });

  try {
    const {
      email,
      nome_cliente,
      pacote_id,
      preco_mensal,
      pacote_nome,
      assinatura_id_base44
    } = req.body;

    // 1 — Criar cliente no Stripe
    const customer = await stripe.customers.create({
      email,
      name: nome_cliente,
    });

    // 2 — Criar produto no Stripe
    const product = await stripe.products.create({
      name: pacote_nome,
      metadata: { pacote_id }
    });

    // 3 — Criar preço recorrente
    const price = await stripe.prices.create({
      unit_amount: preco_mensal * 100,
      currency: "BRL",
      recurring: { interval: "month" },
      product: product.id,
    });

    // 4 — Criar assinatura (billing automático)
    const subscription = await stripe.subscriptions.create({
      customer: customer.id,
      items: [{ price: price.id }],
      metadata: {
        assinatura_id_base44,
        pacote_id
      }
    });

    return res.status(200).json({
      status: "OK",
      customer_id: customer.id,
      subscription_id: subscription.id,
      price_id: price.id,
      product_id: product.id
    });

  } catch (error) {
    return res.status(500).json({ error: error.message });
  }
}
